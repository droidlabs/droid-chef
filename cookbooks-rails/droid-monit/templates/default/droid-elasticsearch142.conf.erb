# ------------------------------------------
# Monit configuration file for ElasticSearch142
# ------------------------------------------

check process elasticsearch142 with pidfile <%= node.elasticsearch142[:pid_file] %>
  start program = "/usr/sbin/service elasticsearch142 start" with timeout 60 seconds
  stop program  = "/usr/sbin/service elasticsearch142 stop"
  if cpu > 90% for 15 cycles then alert
  if totalmem > 90% for 15 cycles then alert
  if loadavg(15min) greater than 10 for 50 cycles then alert
  group elasticsearch142


check host elasticsearch_connection142 with address 0.0.0.0
  if failed url http://0.0.0.0:<%= node.elasticsearch142[:http][:port] %>/ with timeout 15 seconds than 2 for 3 cycles then restart
  group elasticsearch142

<% if node.monit[:notify_email] %>
check host elasticsearch_cluster_health142 with address 0.0.0.0
  if failed url http://0.0.0.0:<%= node.elasticsearch142[:http][:port] %>/_cluster/health
     and content == 'green'
     with timeout 60 seconds
     then alert
     alert <%= node.monit[:notify_email] %> with mail-format {
       subject:  [Monit] elasticsearch: CLUSTER HEALTH PROBLEM $EVENT at <%= node.hostname %>
       message:  [<%= node.hostname %>] $SERVICE $ACTION
                 <% if node.monit[:http_auth] && node.cloud %>
                 --
                 http://<%= node.monit[:http_auth]['username'] %>:<%= node.monit[:http_auth]['password_encoded'] %>@<%= node.cloud.public_hostname %>:2812/elasticsearch_cluster_health
                 <% end %>
     }
  group elasticsearch142
<% end %>
