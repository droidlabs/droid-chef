# <%= @app_name %> - <%= @web_urls %>
server {
  listen 80<%= ' default' if @default %>;
  client_max_body_size 4G;
  server_name <%= @web_urls %>;
  root /data/<%= @app_name %>/current/public;

  # Block bots who like track urls (php usually)
  location ~ \.php$ {
    deny  all;
  }
  location = /500.html {
    root /data/<%= @app_name %>/current/public;
  }
  location ~ ^/(assets)/  {
    root /data/<%= @app_name %>/current/public;

    <%- if node[:nginx][:gzip] %>
      gzip_static on;
      gzip_http_version 1.0;
    <% end -%>

    expires max;
    add_header Cache-Control public;

    error_page 404 /404.html;
  }

  location /nginx_stub_status {
    stub_status on;
  }

  passenger_enabled on;
  passenger_min_instances <%= @app_workers %>;
  rails_env <%= @app_env %>;

  access_log  /data/<%= @app_name %>/shared/log/nginx.access.log;
  error_log   /data/<%= @app_name %>/shared/log/nginx.error.log;
}
<% if @ssl_support %>
server {
  listen 443;
  client_max_body_size 4G;
  server_name <%= @web_urls %>;
  root /data/<%= @app_name %>/current/public;

  # Block bots who like track urls (php usually)
  location ~ \.php$ {
    deny  all;
  }
  location = /500.html {
    root /data/<%= @app_name %>/current/public;
  }
  location ~ ^/(assets)/  {
    root /data/<%= @app_name %>/current/public;

    <%- if node[:nginx][:gzip] %>
      gzip_static on;
      gzip_http_version 1.0;
    <% end -%>

    expires max;
    add_header Cache-Control public;

    error_page 404 /404.html;
  }

  passenger_enabled on;
  passenger_min_instances 1;
  rails_env <%= @app_env %>;

  access_log  /data/<%= @app_name %>/shared/log/nginx.access.log;
  error_log   /data/<%= @app_name %>/shared/log/nginx.error.log;
  ssl on;
  ssl_certificate <%= node[:nginx][:path] %>/ssl/<%= @app_name %>.crt;
  ssl_certificate_key <%= node[:nginx][:path] %>/ssl/<%= @app_name %>.key;
  ssl_protocols SSLv3 TLSv1;
  ssl_ciphers ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!MD5:!aNULL:!EDH:!AESGCM;
  ssl_prefer_server_ciphers on;
}
<% end %>